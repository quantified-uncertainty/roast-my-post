name: Integration Tests on Merge

on:
  push:
    branches: [main]

jobs:
  trigger-integration-tests:
    name: Trigger Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Manual Integration Tests Workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Trigger the manual integration tests workflow
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'manual-integration-tests.yml',
              ref: 'main',
              inputs: {
                test_suite: 'integration',  // Just integration tests
                test_pattern: '',
                max_cost_dollars: '0.00',
                send_slack_notification: 'false'
              }
            });
            
            console.log('Triggered integration tests workflow');
            
            // Add summary
            await core.summary
              .addHeading('ðŸ”„ Post-Merge Integration Tests Triggered')
              .addTable([
                [{data: 'Commit', header: true}, {data: '${{ github.sha }}'}],
                [{data: 'Author', header: true}, {data: '${{ github.actor }}'}],
                [{data: 'Test Suite', header: true}, {data: 'Integration'}]
              ])
              .write();
      
      - name: Trigger Playwright Tests Workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Trigger playwright tests separately
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'manual-integration-tests.yml',
              ref: 'main',
              inputs: {
                test_suite: 'playwright',
                test_pattern: '',
                max_cost_dollars: '0.00',
                send_slack_notification: 'false'
              }
            });
            
            console.log('Triggered Playwright tests workflow');
            
            // Add to summary
            await core.summary
              .addRaw('âœ… Playwright tests also triggered\n')
              .addRaw(`[View running workflows](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions)`)
              .write();