/**
 * Prompt for multi-dimensional scoring of evaluation comments
 */

import type { Comment } from "../../shared/types";
import { DIMENSION_DESCRIPTIONS, QUALITY_DIMENSIONS, COLLECTION_DIMENSIONS } from "../types";

function formatComments(comments: Comment[]): string {
  if (comments.length === 0) {
    return "(No comments provided)";
  }

  return comments
    .map((c, i) => {
      const parts = [
        `Comment ${i + 1}:`,
        `  Header: ${c.header || "(none)"}`,
        `  Level: ${c.level || "(none)"}`,
        `  Description: ${c.description}`,
        `  Quoted text: "${c.highlight.quotedText}"`,
      ];
      if (c.importance !== undefined) {
        parts.push(`  Importance: ${c.importance}`);
      }
      return parts.join("\n");
    })
    .join("\n\n");
}

function formatDimensionInstructions(): string {
  const allDimensions = [...QUALITY_DIMENSIONS, ...COLLECTION_DIMENSIONS];
  return allDimensions
    .map((dim) => `- **${dim.toUpperCase()}**: ${DIMENSION_DESCRIPTIONS[dim]}`)
    .join("\n");
}

export function buildScoringPrompt(
  sourceText: string,
  comments: Comment[],
  agentName?: string
): string {
  const agentContext = agentName
    ? `These comments were generated by the "${agentName}" agent.`
    : "";

  return `You are an expert evaluator assessing the quality of AI-generated document analysis comments.

## Task
Score the following set of comments on multiple quality dimensions. Each dimension should be scored 1-10.

## Source Document
<document>
${sourceText}
</document>

## Comments to Evaluate
${agentContext}

<comments>
${formatComments(comments)}
</comments>

## Scoring Dimensions

Rate each dimension from 1 (poor) to 10 (excellent):

${formatDimensionInstructions()}

## Output Format

Respond with a JSON object in this exact format:
\`\`\`json
{
  "dimensions": {
    "accuracy": { "score": <1-10>, "explanation": "<brief explanation>" },
    "importance": { "score": <1-10>, "explanation": "<brief explanation>" },
    "clarity": { "score": <1-10>, "explanation": "<brief explanation>" },
    "surprise": { "score": <1-10>, "explanation": "<brief explanation>" },
    "verifiability": { "score": <1-10>, "explanation": "<brief explanation>" },
    "tone": { "score": <1-10>, "explanation": "<brief explanation>" },
    "coverage": { "score": <1-10>, "explanation": "<brief explanation>" },
    "redundancy": { "score": <1-10>, "explanation": "<brief explanation>" }
  },
  "overallScore": <1-10 weighted average>,
  "reasoning": "<2-3 sentence overall assessment>"
}
\`\`\`

Be rigorous and honest in your scoring. A score of 5 is average, 7 is good, 9+ is exceptional.`;
}
